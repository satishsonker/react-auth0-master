<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>React App with Auth0</title>
  <!-- CSS only -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
  <!-- JavaScript Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script>
    var checkUserId = setInterval(function () {
      if (window.iotGlobal !== undefined && window.iotGlobal.userKey && window.iotGlobal.userKey !== '') {
        clearInterval(checkUserId);
        runMqtt();
      }
    }, 3000);
    function runMqtt() {
      const xhttp = new XMLHttpRequest();
      xhttp.onload = function () {
        let apiKey = JSON.parse(this.responseText).apiKey;
        connectMqtt(apiKey);
        window.iotGlobal['apiKey'] = apiKey;
      }
      xhttp.open("GET", "http://www.iotHomeAutomation.somee.com/api/v1/user/getApiKey", true);
      xhttp.setRequestHeader('userkey', window.iotGlobal.userKey);
      xhttp.send();
    }
    function connectMqtt(topic) {
      var _topic = [topic, topic + '/server']
      client = new Paho.MQTT.Client('broker.hivemq.com', Number(8000), "web" + new Date().getTime());

      // set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      // connect the client
      client.connect({ onSuccess: onConnect, keepAliveInterval: 60 });


      // called when the client connects
      function onConnect() {
        // Once a connection has been made, make a subscription and send a message.
        console.log('Connected From MQTT')
        client.subscribe(_topic[0]);
        client.subscribe(_topic[1]);
        setInterval(function () {
          let localData = JSON.parse(localStorage.getItem('mqttdevicedataPub'));
          localData = localData === undefined || localData === null ? [] : localData;
          while (localData.length > 0) {
            let pubData = localData.pop();
            let topic = pubData.topic;
            pubData.topic = '';
            if (topic !== undefined && topic !== null && topic !== "") {
              try {
                client.send(topic, JSON.stringify(pubData));
              } catch (error) {

              }
            }
          }
          localStorage.setItem('mqttdevicedataPub', JSON.stringify([]));
        }, 1000);
      }

      // called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:" + responseObject.errorMessage);
        }
      }

      // called when a message arrives
      function onMessageArrived(message) {
        console.log("onMessageArrived:" + message.payloadString);
        var data;
        try {
          data = JSON.parse(message.payloadString.replace(/'/g, '"').replace(',]', ']'));
          let existedDevices = [];
          data['timeStamp'] = new Date();
          var oldData = message.destinationName.indexOf('server') === -1 ? JSON.parse(localStorage.getItem('mqttdevicedataSub')) : JSON.parse(localStorage.getItem('mqttdevicedataSubServer'));
          oldData = oldData === undefined || oldData === null ? [] : oldData;
          if (data !== undefined || data !== null) {
            data["timeStamp"] = new Date();
            oldData.push(data)
            if (message.destinationName.indexOf('server') === -1)
              localStorage.setItem('mqttdevicedataSub', JSON.stringify(oldData));
            else
              localStorage.setItem('mqttdevicedataSubServer', JSON.stringify(oldData));
          }

        } catch (error) {
          //localStorage.setItem('mqttdevicedata', JSON.stringify([]));
          /*   data = {
              "wifi": 'Not Connected',
              "ip": '0.0.0.0',
              "state": 'Not Connected',
              "deviceId": ''
            }
            localStorage.setItem('mqttdevicedata', JSON.stringify(data)); */
        }

      }



    }
  </script>
</body>

</html>